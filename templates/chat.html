{% block head %}
    <title>Chat</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.staticfile.org/twitter-bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.staticfile.org/jquery/2.1.1/jquery.min.js"></script>
    <script src="https://cdn.staticfile.org/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.0/moment.min.js"></script>
{% endblock %}

{% block csstyle %}
    <style>
        body{
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
            display: table;
            position: fixed;
            bottom: 0px;
        }

        /* The following link shows how to create css tables:
        https://stackoverflow.com/questions/90178/make-a-div-fill-the-height-of-the-remaining-screen-space */
        section{
            display: table-row;
            /*background: yellow;*/
        }

        section + section{
            /* Do not delete section + section. It's to build a css table. */
            /*background: red;*/
        }

        section + section + section{
            /* Do not delete section + section + section. It's to build a css table. */
            /*background: blue;*/
        }

        section + section + section + section{
            /* Do not delete section + section + section + section. It's to build a css table. */
            /*background: pink;*/
        }
        
        section + section + section + section + section{
            /* Do not delete section + section + section + section + section. It's to build a css table. */
            /*background: green;*/
        }

        .chatbox_view{
            padding: 0;
            height: 100%;
            width: 100%;
        }

        .lite-chatbox{
            padding: 0;
            overflow-x: hidden;
            overflow-y: auto;
            height: 100%;
            width: 100%;
        }

        .lite-chatbox .cmsg{position:relative;margin:4px 7px;min-height:50px;border:0}
        .lite-chatbox .cright{text-align:right;margin-left:64px}
        .lite-chatbox .cleft{text-align:left;margin-right:64px}
        .lite-chatbox img.headIcon{width:34px;height:34px;top:9px;position:absolute;border:1px solid #c5d4c4}
        .lite-chatbox .name{color:#8b8b8b;font-size:12px;display:block;line-height:18px}
        .lite-chatbox .name .htitle{display:inline-block;padding:0 3px;background-color:#ccc;color:#fff;-moz-border-radius:4px;-webkit-border-radius:4px;border-radius:4px;margin-right:4px;font-size:11px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;vertical-align:middle;max-width:50px}
        .lite-chatbox .content{word-break:break-word;word-wrap:break-word;text-align:left;position:relative;display:inline-block;font-size:15px;padding:10px 15px;line-height:20px;min-width:9px;min-height:18px}.lite-chatbox .content img{width:100%;height:auto}.lite-chatbox .content a{color:#0072C1;margin:0 5px;cursor:hand}
        .lite-chatbox .tips{margin:12px;text-align:center;font-size:12px}.lite-chatbox .tips span{display:inline-block;padding:4px;background-color:#ccc;color:#fff;-moz-border-radius:6px;-webkit-border-radius:6px;border-radius:6px}
        .lite-chatbox img.radius{-moz-border-radius:100%;-webkit-border-radius:100%;border-radius:100%}.lite-chatbox .cright img.headIcon{right:0}.lite-chatbox .cleft img.headIcon{left:0}
        .lite-chatbox .cright .name{margin:0 48px 2px 0}
        .lite-chatbox .cleft .name{margin:0 0 2px 48px}
        .lite-chatbox .cright .content{margin:0 0 0 0;-webkit-border-radius:20px 0 20px 20px;border-radius:20px 0 20px 20px;color:#fff;background:-webkit-linear-gradient(70deg,#3FD1E1 0%,#44D7CD 100%);background: #B93FA3;-webkit-box-shadow:5px 5px 15px 0 rgba(102,102,102,0.15);box-shadow:5px 5px 15px 0 rgba(102,102,102,0.15)}
        .lite-chatbox .cleft .content{margin:0 0 0 48px;-webkit-border-radius:0 20px 20px 20px;border-radius:0 20px 20px 20px;color:#666;border:1px solid rgba(0,0,0,0.05);background:#FFF;-webkit-box-shadow:5px 5px 15px 0 rgba(102,102,102,0.1);box-shadow:5px 5px 15px 0 rgba(102,102,102,0.1)}
        .lite-chatbox .cright .content:after{right:-12px;top:8px}
        .lite-chatbox .cleft .content:after{left:-12px;top:8px}
        .lite-chatbox .tips .tips-primary{background-color:#3986c8}
        .lite-chatbox .tips .tips-success{background-color:#49b649}
        .lite-chatbox .tips .tips-info{background-color:#5bb6d1}
        .lite-chatbox .tips .tips-warning{background-color:#eea948}
        .lite-chatbox .tips .tips-danger{background-color:#e24d48}
        .lite-chatbox .name .admin{background-color:#72D6A0}
        .lite-chatbox .name .owner{background-color:#F2BF25}

        .lite-chatbox .time_stamp{
            color:#8b8b8b;font-size:12px;display:block;line-height:18px;
        }

        .lite-chatbox .cright .time_stamp{
            margin:4px 28px 8px 0;
        }

        .lite-chatbox .cleft .time_stamp{
            margin:4px 0 8px 72px;
        }
        
        .text_input{
            float: left;
            padding-right: 10px;
            width: 85%;
        }

        .send_button{
            background-image: linear-gradient(90deg, #6737E5 50%, #B93FA3 80%);
            width: 15%;
            height: 70px;
            color:white;
            font-size: 2.5vw;
            text-align: center;
            border-radius: 14px;
        }

        .special{
            border-radius:5px;
            border: 0;
            background-color:rgba(241,241,241,.98);
            resize: none;
            width: 100%;
            height: 70px;
            overflow-y: auto;
        }

        .content1{
            padding-top: 20px;
        }

        .content{
            /*word-wrap: break-spaces;*/
        }

        .butt3{
            float: right;
            margin-right: 10px;
        }

        .navbar {
            background-image: linear-gradient(#54B4EB, #2FA4E7 60%, #1D9CE5);
            background-repeat: no-repeat;
            border-bottom: 1px solid #178ACC;
            box-shadow: 0px 1px 10px rgba(0, 0, 0, 0.1);
            border-radius: 0px;
        }

        .navbar-default {
            background-image: linear-gradient(90deg, #6737E5 50%, #B93FA3 80%);
            border-style: none;;
            border-color: #FC4F6C;
        }

        .navbar-default .navbar-brand,
        .navbar-default .navbar-brand:hover,
        .navbar-default .navbar-brand:focus ,
        .navbar-default .navbar-nav > li > a {
            color: #FFF;
        }

        .navbar-default .navbar-nav > li > a:hover,
        .navbar-default .navbar-nav > li > a:focus {
            color: #FFF;
            background-color: #FC8909;
        }

        .navbar-default .navbar-toggle:hover,
        .navbar-default .navbar-toggle:focus {
            background-color: #FC8909;
        }

        .navbar-default .navbar-toggle {
            border-color: #FC8909;
        }

        .navbar-default .navbar-toggle .icon-bar {
            background-color: #FFF;
        }

        .fas{
            color: white;
        }

        .report_box {
            display: none;
        }

        .to {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            margin-left: -43px;
            margin-top: -43px;
            background-color: white;
        }

        .flexbox-image {
            width: 125px;
            float: left;
            padding-top: 10px;
            padding-left: 20px;
        }

        .circular--portrait {
            /*position: relative;*/
            width: 100%;
            height: auto;
            overflow: hidden;
            border-radius: 50%;
            display: inline-block;
        }

        .circular--portrait img {
            max-width: 100%;
            height: auto;
        }

        .autama_description{
            float: left;
            padding-left: 20px;
            width: 75%;
        }

        .profile_view{
            padding: 0;
            height: 20%;
            width: 100%;
        }

        .profile_box{
            padding: 0;
            overflow-x: hidden;
            overflow-y: auto;
            height: 100%;
            width: 100%;
        }

        .match_warning{
            height: 80%;
            width: auto;
            text-align: center;
        }

        .match_button{
            background: #ff4e50;
            height: auto;
            width: 50%;
            color: white;
            font-size: 10vw;
            text-align: center;
            vertical-align: middle;
            border-radius: 10vw;
        }
    </style>
{% endblock %}

{% block js %}
    <script>
        /* function to convert iso utc time from the DB to local time in the browser */
        function convertTime(timestamp) {
            return moment.utc(timestamp).local().format('MMM D YYYY, h:mm a');
        }
        
        function showReport() {
            if (document.getElementById("report").style.display != "block") {
                div = document.getElementById("report").style.display="block";
            } else {
                div = document.getElementById("report").style.display="none";
            }
        }

        function hideReport() {
            div = document.getElementById("report").style.display="none";
        }
        
        /*
        A little smashed up of the two links below to create a function for submitting with the enter key.
        https://www.formget.com/submit-data-from-textarea-on-enter-key/
        https://stackoverflow.com/questions/155188/trigger-a-button-click-with-javascript-on-the-enter-key-in-a-text-box
        */
        $(document).ready(function() {
            $('form').keydown(function() {
                if (event.keyCode == 13) {
                    document.getElementById("send_button").click();
                    return false;
                }
            });
        });
        
        /*
        The following link shows how to auto scroll to button:
        https://stackoverflow.com/questions/24772491/auto-scroll-to-bottom-div/24772646
        */
        /* A function to go to the latest message in the chat box */
        $(document).ready(function(){
            $('.lite-chatbox').animate({scrollTop: $('.lite-chatbox')[0].scrollHeight}, 0);
        });
        
        /*
        The following link shows how to go back to previous page:
        https://www.w3schools.com/jsref/met_his_back.asp
        */
        function goBackOne() {
          window.history.back();
        }
        
        /*
        The following link shows how to go back multiple pages:
        https://www.w3schools.com/jsref/met_his_go.asp
        */
        function goBack(pages) {
          window.history.go(-pages);
        }

        function match_with(){
            document.getElementById("nav_match").click();
        }
    </script>
{% endblock %}

{% block content %}
    <body>

        <nav class="nav navbar-inverse navbar-default navbar-fixed-top" role="navgation">
            <div class="container-fluid">
                <div class="navbar-header">
                    <button class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                </div>

                <div class="collapse navbar-collapse">
                    <ul class="navbar-nav nav">
                        {% if request.user.is_authenticated  %}
                            <li style="font-size: 25px;"><a href="{{ last_page }}"><b><</b></a></li>
                        {% endif %}
                    </ul>

                    <ul class="nav navbar-nav navbar-right">
                        {% if is_matched %}
                            <li><a onclick="">Share</a></li>
                        
                            <li><a href="{% url 'UnMatch' pk=autama.pk %}">
                                {% csrf_token %}
                                Unmatch
                            </a></li>
                        
                            <li><a onclick="showReport()">Report</a></li>
                        {% else %}
                            <li><a id="nav_match" href="{% url 'Match' pk=autama.pk %}">
                                {% csrf_token %}
                                Match
                            </a></li>
                        {% endif %}
                    </ul>
                </div>

                <!--<div>
                    <a href="/AutamaProfiles/{{ autama.pk }}-{{ autama.first }}-{{ autama.last }}">
                        <img  style="position: relative; " class="to" alt="aaa" src="{{ autama.picture.url }}">
                    </a>
                </div>-->
            </div>
        </nav>

        <!--create some space between nav and chat box-->
        <section><div style="margin-top: 70px;"></div></section>

        <section class="profile_view">
            <div class="profile_box">
                <div class="flexbox-image">
                    <div class="circular--portrait">
                        <img src="{{ autama.picture.url }}" alt="Avatar"/>
                    </div>
                </div>

                <div class="autama_description">
                    <h5><b>{{ autama.first }} {{ autama.last }} </b></h5>
                    <p>
                        <b>Description:</b>
                        {{ autama.interest1 }}
                        {{ autama.interest2 }}
                        {{ autama.interest3 }}
                    </p>
                    <p>
                        <b>Creator:</b>
                        {{ autama.creator }}
                    </p>
                    <p>
                        <b>Followers:</b>
                        {{ autama.nummatches }}
                    </p>
                </div>
            </div>
        </section>
        
        <!--create some space between Autama profile and chat box-->
        <section><div style="margin-top: 5px;"></div></section>

        {% if is_matched %}
            <section class="chatbox_view">
                <div class="lite-chatbox">
                    {% for a_message in message_chain %}
                        {% if a_message.sender == 'User' %}
                            <div class="cright cmsg">
                                <span class="content">{{a_message.message}}</span>  <!-- timezone is in UTC -->
                                <span class="time_stamp">{{ a_message.timeStamp.isoformat }}</span>
                            </div>
                        {% else %}
                            <div class="cleft cmsg">
                                <a href="/AutamaProfiles/{{ autama.pk }}-{{ autama.first }}-{{ autama.last }}">
                                    <img class="headIcon radius" ondragstart="return false;" oncontextmenu="return false;" src="{{ autama.picture.url }}">
                                </a>
                                <span class="name">{{autama.first}}</span>
                                <span class="content">{{a_message.message}}</span>
                                <span class="time_stamp">{{ a_message.timeStamp.isoformat }}</span>
                            </div>
                        {% endif %}
                    {% endfor %}
                </div>
            </section>

            <!-- Input/button area -->
            <section>
{#                <form action="{% url 'Chat' pk=autama.pk %}" method="post" enctype="multipart/form-data">#}
{#                    {% csrf_token %}#}
                    <div style="padding: 10px; height: 77px;">
                        <div class="text_input">
{#                            {{ form }}#}
                            <textarea cols="40" rows="10" class="special" id="input_textbox"></textarea>
                        </div>

                        <input id="send_button" type="submit" value="Send" class="send_button">
                    </div>
{#                </form>#}
            </section>

            <!-- jQuery dialog code here: https://stackoverflow.com/questions/40939099/jquery-form-submit-with-confirmation-in-a-modal -->
            <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
            <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/smoothness/jquery-ui.css">
            <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>


            <div id="dialog-confirm" title="Report submitted, thank you!">
                <p>Would you like to provide additional feedback?</p>
            </div>

            <div id="additional-feedback" title="Feedback">
                <form id="feedback-form" action="mailto:autamafeedback@gmail.com" method="post" enctype="text/plain">
                    <textarea rows="5" cols="30">Enter feedback here...</textarea>
                </form>
            </div>

            <script>
                $("#send_button").click(function() {

                    let msg = document.createElement('div');
                    let timebox = document.createElement('span');
                    let contentbox = document.createElement('span');

                    msg.classList.add('cright');
                    msg.classList.add('cmsg');
                    contentbox.classList.add('content');
                    timebox.classList.add('time_stamp');
                    contentbox.innerHTML = $("#input_textbox").val();
                    // TODO: Need to add actual timestamp
                    timebox.textContent = "May 23rd 5pm";

                    msg.appendChild(contentbox);
                    msg.appendChild(timebox);

                    $(".lite-chatbox").append(msg);

                    $.ajax({
                        url : "/Chat/" + {{ autama.pk }} + '/',
                        type: "POST",
                        data : { csrfmiddlewaretoken: "{{ csrf_token }}", 'autama_id': {{ autama.pk }}, 'message': 'test',},
                        success: function(data, textStatus, jqXHR)
                        {
                            let msg = document.createElement('div');
                            let timebox = document.createElement('span');
                            let contentbox = document.createElement('span');

                            msg.classList.add('cleft');
                            msg.classList.add('cmsg');
                            contentbox.classList.add('content');
                            timebox.classList.add('time_stamp');
                            contentbox.innerHTML = data.response;
                            timebox.textContent = convertTime(data.time);

                            msg.appendChild(contentbox);
                            msg.appendChild(timebox);

                            $(".lite-chatbox").append(msg);

                            console.log(data)
                        },
                        error: function (jqXHR, textStatus, errorThrown)
                        {
                            console.log(errorThrown)
                        }
                    });
                });

                /* After page load go to all time_stamp class fields and update to local time */
                $('.time_stamp').text(function(index, text) {
                    return convertTime(text);
                });

                $(function() {
                    $("#additional-feedback").dialog({
                        resizable: false,
                        height: "auto",
                        autoOpen: false,
                        width: "auto",
                        modal: true,
                        position: {
                            my: "left",
                            at: "left",
                            of: "#reportform"
                        },
                        buttons: {
                            "Submit": function() {
                                /* submit feedback here */
                                $(this).dialog("close");
                            },
                            "Close": function() {
                                $(this).dialog("close");
                            }
                        }
                    });

                    $("#dialog-confirm").dialog({
                        resizable: false,
                        height: "auto",
                        autoOpen: false,
                        width: "auto",
                        modal: true,
                        position: {
                            my: "left",
                            at: "left",
                            of: "#reportform"
                        },
                        buttons: {
                            "Yes": function() {
                                $("#additional-feedback").dialog('open');
                                $(this).dialog("close");
                                hideReport();
                                $('#reportform').submit();
                            },
                            No: function() {
                                $(this).dialog("close");
                                hideReport();
                                $('#reportform').submit();
                            }
                        }
                    });

                    $('#submitReport').on('click', function(e) {
                        $("#dialog-confirm").dialog('open');
                    });
                });
            </script>

            <!-- https://www.tutorialspoint.com/How-to-Create-a-Multi-line-Text-Input-Text-Area-In-HTML -->
            <div class="report_box" id="report">
                <!-- <form action="???" method="post"> -->
                <!-- include csrf_token here -->
                <h1>Report Autama</h1>
                <form id="reportform" action="mailto:autamafeedback@gmail.com" method="post" enctype="text/plain">
                    <input style="margin: 15px 15px 15px 15px" type="checkbox" id="option1" name="option1" value="Option 1">
                    <label for="option1"> Inappropriate content</label><br>
                    <input style="margin: 15px 15px 15px 15px" type="checkbox" id="option2" name="option2" value="Option 2">
                    <label for="option2"> Autama is broken</label><br>
                    <input style="margin: 15px 15px 15px 15px" type="checkbox" id="option3" name="option3" value="Option 3">
                    <label for="option3"> Autama is boring</label><br>
                    <input style="margin: 15px 15px 15px 15px" type="checkbox" id="option4" name="option4" value="Option 4">
                    <label for="option4"> Other</label><br><br>

                    <!-- jQuery dialog-confirm code -->
                    <input type="hidden" name="submitReport" value="Submit"/>
                    <input type="button" id="submitReport" value="Submit"/>

                    <button onclick="hideReport()"/>Close</button>
                </form>
            </div>
        {% else %}
        <section class="match_warning">
            <p style="font-size: 2.5vw;">I don't talk to strangers.</p>
            <p style="font-size: 2.5vw;">Match with me, then we'll talk.</p>
            <br>
            <button onclick="match_with()" class="match_button">Match</button>
        </section>

        <section></section>
        {% endif %}

    </body>
{% endblock %}

